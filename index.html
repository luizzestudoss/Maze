<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Multiplayer Blocks</title>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js';

        const SUPABASE_URL = "https://wxvufbzwpipeajlymnoz.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4dnVmYnp3cGlwZWFqbHltbm96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI1ODM2ODgsImV4cCI6MjA0ODE1OTY4OH0.ZGa7xAG0GGW5JqLmqxkgbazsUo7lpHJZeIbj9PKJ4lI";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentPlayer = null;
        let roomId = null;

        // Gera um ID aleatório de 4 dígitos para a sala
        function generateRoomId() {
            return Math.floor(1000 + Math.random() * 9000);
        }

        // Criar uma sala
        window.createRoom = async function () {
            const newRoomId = generateRoomId();
            const { error } = await supabase
                .from('rooms')
                .insert([{ id: newRoomId, players: {} }]);

            if (error) {
                alert("Erro ao criar sala: " + error.message);
                console.error(error);
            } else {
                roomId = newRoomId;
                document.getElementById('room-id').textContent = `Sala criada: ID = ${roomId}`;
            }
        };

        // Entrar na sala
        window.joinRoom = async function () {
            roomId = document.getElementById('input-room-id').value;
            if (!roomId || isNaN(roomId) || roomId.length !== 4) {
                alert("Por favor, insira um ID de sala válido (4 números). ");
                return;
            }

            const { data: room, error: fetchError } = await supabase
                .from('rooms')
                .select('players')
                .eq('id', roomId)
                .single();

            if (fetchError) {
                alert("Erro ao buscar sala: " + fetchError.message);
                console.error(fetchError);
                return;
            }

            const newPlayerName = `Player${Object.keys(room.players).length + 1}`;
            currentPlayer = {
                name: newPlayerName,
                x: Math.random() * 400,
                y: Math.random() * 400
            };

            room.players[currentPlayer.name] = currentPlayer;

            const { error: updateError } = await supabase
                .from('rooms')
                .update({ players: room.players })
                .eq('id', roomId);

            if (updateError) {
                alert("Erro ao entrar na sala: " + updateError.message);
                console.error(updateError);
                return;
            }

            alert(`Você entrou na sala como ${currentPlayer.name}`);
            renderBlocks(room.players);
            listenToRoom();

            document.querySelectorAll('div, input, button').forEach(el => el.style.display = 'none');
            document.getElementById('game-container').style.display = 'block';
        };

        // Escutar mudanças na sala
        function listenToRoom() {
            supabase
                .channel(`rooms:${roomId}`)
                .on(
                    'postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomId}` },
                    (payload) => {
                        renderBlocks(payload.new.players);
                    }
                )
                .subscribe();
        }

        // Renderizar os blocos na tela
        function renderBlocks(players) {
            const container = document.getElementById('game-container');
            container.innerHTML = '';

            Object.values(players).forEach(player => {
                const block = document.createElement('div');
                block.className = 'block';
                block.textContent = player.name;
                block.style.left = player.x + 'px';
                block.style.top = player.y + 'px';
                container.appendChild(block);
            });
        }

        // Atualiza apenas a posição do jogador atual
        async function updatePlayerPosition() {
            const updates = { [`players.${currentPlayer.name}`]: currentPlayer };
            const { error: updateError } = await supabase
                .from('rooms')
                .update(updates)
                .eq('id', roomId);

            if (updateError) {
                console.error(updateError);
            }
        }

        document.addEventListener('keydown', (event) => {
            if (!currentPlayer || !roomId) return;

            switch (event.key) {
                case 'ArrowUp':
                    currentPlayer.y = Math.max(0, currentPlayer.y - 10);
                    break;
                case 'ArrowDown':
                    currentPlayer.y = Math.min(450, currentPlayer.y + 10);
                    break;
                case 'ArrowLeft':
                    currentPlayer.x = Math.max(0, currentPlayer.x - 10);
                    break;
                case 'ArrowRight':
                    currentPlayer.x = Math.min(450, currentPlayer.x + 10);
                    break;
                default:
                    return;
            }

            updatePlayerPosition();
        });
    </script>
    <style>
        #game-container {
            width: 500px;
            height: 500px;
            border: 1px solid black;
            position: relative;
            display: none; /* Esconde até entrar na sala */
        }
        .block {
            width: 50px;
            height: 50px;
            position: absolute;
            background-color: lightblue;
            text-align: center;
            line-height: 50px;
            border: 1px solid blue;
        }
    </style>
</head>
<body>
    <h1>Supabase Multiplayer Blocks</h1>

    <!-- Criar sala -->
    <div>
        <button onclick="createRoom()">Criar Sala</button>
        <p id="room-id"></p>
    </div>

    <!-- Entrar na sala -->
    <div>
        <h3>Entrar na Sala</h3>
        <input type="text" id="input-room-id" placeholder="Insira o ID da Sala (4 números)">
        <button onclick="joinRoom()">Entrar na Sala</button>
    </div>

    <!-- Container do Jogo -->
    <div id="game-container"></div>
</body>
</html>
