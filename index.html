<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Multiplayer Blocks</title>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js';

        const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
        const SUPABASE_KEY = import.meta.env.VITE_SUPABASE_KEY;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentPlayer = null;
        let roomId = null;

        // Criar uma sala
        window.createRoom = async function () {
            const { data, error } = await supabase
                .from('rooms')
                .insert([{ players: [] }])
                .select();

            if (error) {
                alert("Erro ao criar sala: " + error.message);
                console.error(error);
            } else {
                roomId = data[0].id;
                document.getElementById('room-id').textContent = `Sala criada: ID = ${roomId}`;
            }
        };

        // Entrar na sala
        window.joinRoom = async function () {
            roomId = document.getElementById('input-room-id').value;
            if (!roomId) {
                alert("Por favor, insira um ID de sala válido.");
                return;
            }

            // Obter dados da sala
            const { data: room, error: fetchError } = await supabase
                .from('rooms')
                .select('players')
                .eq('id', roomId)
                .single();

            if (fetchError) {
                alert("Erro ao buscar sala: " + fetchError.message);
                console.error(fetchError);
                return;
            }

            // Adicionar o novo jogador
            const newPlayer = {
                name: `Player${room.players.length + 1}`,
                x: Math.random() * 400, // Posição inicial aleatória
                y: Math.random() * 400
            };
            currentPlayer = newPlayer;

            const updatedPlayers = [...room.players, newPlayer];

            const { error: updateError } = await supabase
                .from('rooms')
                .update({ players: updatedPlayers })
                .eq('id', roomId);

            if (updateError) {
                alert("Erro ao entrar na sala: " + updateError.message);
                console.error(updateError);
                return;
            }

            alert(`Você entrou na sala como ${newPlayer.name}`);
            renderBlocks(updatedPlayers);
            listenToRoom();
        };

        // Escutar mudanças na sala
        function listenToRoom() {
            supabase
                .channel(`rooms:${roomId}`)
                .on(
                    'postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomId}` },
                    (payload) => {
                        const players = payload.new.players;
                        renderBlocks(players);
                    }
                )
                .subscribe();
        }

        // Renderizar os blocos na tela
        function renderBlocks(players) {
            const container = document.getElementById('game-container');
            container.innerHTML = ''; // Limpa os blocos anteriores

            players.forEach(player => {
                const block = document.createElement('div');
                block.className = 'block';
                block.textContent = player.name;
                block.style.left = player.x + 'px';
                block.style.top = player.y + 'px';
                container.appendChild(block);
            });
        }

        // Mover o bloco do jogador atual
        window.moveBlock = async function (direction) {
            if (!currentPlayer || !roomId) {
                alert("Você precisa entrar na sala primeiro.");
                return;
            }

            // Atualiza a posição do jogador atual
            if (direction === 'up') currentPlayer.y -= 10;
            if (direction === 'down') currentPlayer.y += 10;
            if (direction === 'left') currentPlayer.x -= 10;
            if (direction === 'right') currentPlayer.x += 10;

            // Atualiza no Supabase
            const { data: room, error: fetchError } = await supabase
                .from('rooms')
                .select('players')
                .eq('id', roomId)
                .single();

            if (fetchError) {
                console.error(fetchError);
                return;
            }

            const updatedPlayers = room.players.map(player =>
                player.name === currentPlayer.name ? currentPlayer : player
            );

            const { error: updateError } = await supabase
                .from('rooms')
                .update({ players: updatedPlayers })
                .eq('id', roomId);

            if (updateError) {
                console.error(updateError);
            }
        };
    </script>
    <style>
        #game-container {
            width: 500px;
            height: 500px;
            border: 1px solid black;
            position: relative;
        }
        .block {
            width: 50px;
            height: 50px;
            position: absolute;
            background-color: lightblue;
            text-align: center;
            line-height: 50px;
            border: 1px solid blue;
        }
    </style>
</head>
<body>
    <h1>Supabase Multiplayer Blocks</h1>

    <!-- Criar sala -->
    <div>
        <button onclick="createRoom()">Criar Sala</button>
        <p id="room-id"></p>
    </div>

    <!-- Entrar na sala -->
    <div>
        <h3>Entrar na Sala</h3>
        <input type="text" id="input-room-id" placeholder="Insira o ID da Sala">
        <button onclick="joinRoom()">Entrar na Sala</button>
    </div>

    <!-- Controles -->
    <div>
        <h3>Controles</h3>
        <button onclick="moveBlock('up')">Cima</button>
        <button onclick="moveBlock('down')">Baixo</button>
        <button onclick="moveBlock('left')">Esquerda</button>
        <button onclick="moveBlock('right')">Direita</button>
    </div>

    <!-- Container do Jogo -->
    <div id="game-container"></div>
</body>
</html>
